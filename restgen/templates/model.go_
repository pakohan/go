package {{remove_underscores .Model.TableName}}

import (
	"context"
	"database/sql"
	"embed"
	"log"
	"time"

	"github.com/pakohan/go/httphelper"
	"github.com/pakohan/go/modelhelper"
	"github.com/pakohan/go/sqlrepo"
)

//go:embed sql
var sqlDir embed.FS

type Model struct {
	l  *log.Logger
	db modelhelper.DB
	q  *sqlrepo.SQLRepository
}

type {{pascal .Model.TableName}} struct {
	{{range .Columns -}}
	{{pascal .Name}} {{if .IsNullable}}*{{end}}{{.DataType}} `json:"{{.Name}}" db:"{{.Name}}"`
	{{end -}}
}

type Filter struct {
	Page     int `json:"page" db:"page"`
	PageSize int `json:"page_size" db:"page_size"`
	{{range .Columns -}}
	{{if .IsFilter}}
	{{pascal .Name}} {{if eq .DataType "time.Time"}}*{{end}}{{.DataType}} `json:"{{.Name}}" db:"{{.Name}}"`
	{{- end -}}
	{{end -}}
}

func New(l *log.Logger, db modelhelper.DB) *Model {
	return &Model{
		l:  l,
		db: db,
		q:  sqlrepo.New(l, sqlDir, "sql"),
	}
}

func (m *Model) List(ctx context.Context, res *httphelper.List[{{pascal .Model.TableName}}, Filter]) error {
	res.Filter.Page = res.Page
	res.Filter.PageSize = res.PageSize
	err := m.db.NamedSelectContext(ctx, &res.Elements, m.q.Query("list", res), res.Filter)
	if err != nil {
		m.l.Printf("[model][{{remove_underscores .Model.TableName}}][List] err: %v", err)
	}

	return err
}

func (m *Model) Insert(ctx context.Context, data {{pascal .Model.TableName}}) (*{{pascal .Model.TableName}}, error) {
	res := &{{pascal .Model.TableName}}{}
	err := m.db.NamedGetContext(ctx, res, m.q.Query("insert"), data)
	if err != nil {
		m.l.Printf("[model][{{remove_underscores .Model.TableName}}][Create] err: %v", err)
	}

	return res, err
}
func (m *Model) Get(ctx context.Context, id int) (*{{pascal .Model.TableName}}, error) {
	res := &{{pascal .Model.TableName}}{}
	err := m.db.GetContext(ctx, res, m.q.Query("get"), id)
	if err != nil {
		m.l.Printf("[model][{{remove_underscores .Model.TableName}}][Get] err: %v", err)
	}

	return res, err
}

func (m *Model) Update(ctx context.Context, data {{pascal .Model.TableName}}) (*{{pascal .Model.TableName}}, error) {
	res := &{{pascal .Model.TableName}}{}
	err := m.db.NamedGetContext(ctx, res, m.q.Query("update"), data)
	if err == sql.ErrNoRows {
		res = nil
		err = nil
	} else if err != nil {
		m.l.Printf("[model][{{remove_underscores .Model.TableName}}][Update] err: %v", err)
	}

	return res, err
}

func (m *Model) Delete(ctx context.Context, id int) error {
	_, err := m.db.ExecContext(ctx, m.q.Query("delete"), id)
	if err != nil {
		m.l.Printf("[model][{{remove_underscores .Model.TableName}}][Deleete] err: %v", err)
	}

	return err
}
